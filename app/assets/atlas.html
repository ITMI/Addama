<!doctype html>
<!--<html lang="en">-->
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <link rel="shortcut icon" href="img/isbfavicon.ico" type="image/x-icon"/>
    <meta charset="utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, width=device-width, height=device-height, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>QED: Atlas</title>

    <link rel="stylesheet" href="css/app.css">
    <script src="js/vendor.js"></script>
    <script src="js/app.js"></script>
    <script>require("initialize");</script>
</head>

<body>

<div class="navbar-fixed-top">
    <div class="navbar" id="navigation-container"></div>

    <ul class="atlas-navigator nav nav-list">
        <li><a href="#" onclick="return false;" class="zoom-home"> <i class="icon-home"/></i> </a></li>
        <li><a href="#" onclick="return false;" class="zoom-in"> <i class="icon-zoom-in"/></i> </a></li>
        <li><a href="#" onclick="return false;" class="zoom-out"> <i class="icon-zoom-out"/></i> </a></li>
        <li><a href="#" onclick="return false;" class="resize-item"> <i class="icon-resize-full"/></i> </a></li>
        <li><a href="#" onclick="return false;" class="scale-item"> <i class="icon-fullscreen"/></i> </a></li>
        <li><a href="#" onclick="return false;" class="refresh-loaded"> <i class="icon-refresh"/></i> </a></li>
    </ul>

    <ul class="nav nav-pills cancer-selector"></ul>

    <div class="pull-right">
        <input class="genes-typeahead" type="text" placeholder="Add a gene..."/>
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" onclick="return false;"> <i class="icon-list"></i> </a>
        <ul class="dropdown-menu gene-selector">
            <li><a href="#" onclick="return false;" class="item-remover" data-id="TP53">TP53 <i class="icon-trash"></i> </a></li>
            <li><a href="#" onclick="return false;" class="item-remover" data-id="CTCF">CTCF <i class="icon-trash"></i> </a></li>
        </ul>
    </div>

    <div class="pull-left">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" onclick="return false;">Maps <b class="caret"></b></a>
        <ul class="dropdown-menu maps-selector"></ul>
    </div>
</div>

<div class="atlas-body">
    <div class="atlas-canvas">
        <div class="atlas-zoom">
        </div>
    </div>
</div>

<script type="text/javascript">
    var atlas;
    $(function () {
        var Atlas = require("lib/atlas");
        atlas = new Atlas($(".atlas-body"));

        var AtlasMapTemplate = require("views/templates/atlasmap");
        var LineItemTemplate = require("views/templates/line_item");
        var lastZindex = 10;
        var loadAtlas = function () {
            var appendAtlasMap = function(atlasZoom, map) {
                $(atlasZoom).append(AtlasMapTemplate(map));
                var $atlasMap = $(".atlas-zoom").children().last();
                $atlasMap.draggable({ "scroll":true });
                _.each($atlasMap.find(".map-contents"), function(mc) {
                    atlas.navigate($(mc));
                });

                $atlasMap.find("a.minimize").click(function(e) {
                    var atlasMap = $(e.target).parents(".atlas-map");
                    atlasMap.effect("transfer", {
                        "to": $(".maps-selector").find("li"),
                        complete: function() {
                            atlasMap.remove();
                        }
                    }, 750);
                });
                $atlasMap.find("a.refresh-me").click(function(e) {
                    _.each($(e.target).parents(".atlas-map").find(".map-contents"), function(mc) {
                        atlas.navigate($(mc));
                    })
                });
                $atlasMap.click(function(e) {
                    $atlasMap.css("z-index", ++lastZindex);
                });
            };

            var atlasModel = new qed.Models.Default({ "data_uri": "svc/data/qed_atlas.json" });
            atlasModel.fetch({
                success: function() {
                    var maps = atlasModel.get("maps");
                    _.each(maps, function(map) {
                        if (map.isOpen) {
                            appendAtlasMap($(".atlas-zoom"), map);
                        }
                        $(".maps-selector").append(LineItemTemplate({ "a_class": "open-map", "id": map.id, "label": map.label }));
                    });

                    var mapsById = _.groupBy(maps, "id");
                    $(".maps-selector").find(".open-map").click(function(e) {
                        var map = _.first(mapsById[$(e.target).data("id")]);
                        appendAtlasMap($(".atlas-zoom"), map);
                    });
                }
            });

            $(".atlas-zoom").draggable({ "scroll":true });
            $(".gene-selector").sortable();
            $(".cancer-selector").sortable();
        };

        qed.Events.on("ready", loadAtlas);
        $(".refresh-loaded").click(function() {
            _.each($(".atlas-map").find(".map-contents"), function(mc) {
                atlas.navigate($(mc));
            });
        });

        var currentZoomLevel = 1.0;
        $(".zoom-in").click(function () {
            currentZoomLevel = currentZoomLevel * 1.15;
            atlas.zoom(currentZoomLevel);
        });

        $(".zoom-out").click(function () {
            currentZoomLevel = currentZoomLevel * 0.85;
            atlas.zoom(currentZoomLevel);
        });

        $(".zoom-home").click(function () {
            currentZoomLevel = 1.0;
            atlas.zoom(currentZoomLevel);
        });

        $(".resize-item").click(function () {
            var li = $(this).parent();
            if (li.hasClass("active")) {
                $(".atlas-map").resizable("destroy");
            } else {
                $(".atlas-map").resizable({ "ghost":true});
            }
            li.toggleClass("active");
        });

        $(".scale-item").click(function () {
            var li = $(this).parent();
            if (li.hasClass("active")) {
                $(".atlas-map").resizable("destroy");
            } else {
                $(".atlas-map").resizable({
                    "handles":"n, e, s, w, ne, se, sw, nw",
                    "aspectRatio":true,
                    "animateEasing":"linear",
                    "stop":function (e, ui) {
                        var scaleLevel = (ui.size.width / ui.originalSize.width) * 90;
                        $(e.target).children().effect("scale", {"scale":"both", "percent":scaleLevel}, 1000);
                    }
                });
            }
            li.toggleClass("active");
        });
    });
</script>

<!--these scripts are to support lightweight google hangout integration, should not affect how the app runs outside of hangout-->
<!--<script src="//hangoutsapi.talkgadget.google.com/talkgadget/apps/gadgets/js/rpc.js"></script>-->
<!--<script src="//hangoutsapi.talkgadget.google.com/hangouts/api/hangout.js?v=1.0"></script>-->

</body>
</html>

